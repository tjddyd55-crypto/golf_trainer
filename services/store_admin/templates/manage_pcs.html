<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¥ íƒ€ì„(ë£¸) ê´€ë¦¬ - {{ store_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/store_admin.css') }}">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1 class="text-white mb-0">ğŸ¢ ë§¤ì¥ íƒ€ì„(ë£¸) ê´€ë¦¬ - {{ store_name }}</h1>
        </div>
        
        <div class="admin-main-content">
            <div class="mb-3">
                <a href="{{ url_for('store_admin_dashboard') }}" class="admin-btn admin-btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
            
            <div class="alert alert-info">
                <strong>íƒ€ì„(ë£¸) ë“±ë¡ ë°©ë²•:</strong><br>
                1. ê° íƒ€ì„(ë£¸)ì˜ ì»´í“¨í„°ì—ì„œ <code>register_pc.py</code> ì‹¤í–‰<br>
                2. ë§¤ì¥ëª…, íƒ€ì„(ë£¸)ëª…, íƒ€ì„(ë£¸) ì´ë¦„ ì…ë ¥ (ì˜ˆ: 1ë²ˆë°©, 1ë²ˆë£¸)<br>
                3. ì„œë²„ì— ìë™ ë“±ë¡
            </div>
            
            <!-- ì—°ì¥ ìš”ì²­ ì´ë ¥ ì„¹ì…˜ -->
            <div class="mt-4">
                <h4>ğŸ“‹ ì—°ì¥ ìš”ì²­ ì´ë ¥</h4>
                <div id="extension-requests-container">
                    <p class="text-muted">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            {% if pcs %}
            <div class="table-responsive">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>íƒ€ì„(ë£¸)ë²ˆí˜¸</th>
                            <th>íƒ€ì„(ë£¸) ì´ë¦„</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ì‚¬ìš©ê¸°ê°„</th>
                            <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
                            <th>ìƒíƒœ</th>
                            <th>ìƒì„¸ì •ë³´</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pc in pcs %}
                        <tr>
                            <td>
                                {% if pc.bay_name and pc.bay_name.strip() %}
                                    <strong style="font-size: 1.1em; color: #007bff;">{{ pc.bay_name }}</strong>
                                {% elif pc.bay_id %}
                                    {% set bay_num = pc.bay_id|int %}
                                    <strong style="font-size: 1.1em; color: #007bff;">{{ "%02d"|format(bay_num) }}ë²ˆ íƒ€ì„(ë£¸)</strong>
                                {% else %}
                                    <strong style="font-size: 1.1em; color: #007bff;">{{ pc.bay_display or "-" }}</strong>
                                {% endif %}
                            </td>
                            <td><strong>{{ pc.pc_name or pc.bay_name or "-" }}</strong></td>
                            <td>{{ pc.registered_at.split(' ')[0] if pc.registered_at else "-" }}</td>
                            <td>
                                {% if pc.usage_start_date and pc.usage_end_date %}
                                    {{ pc.usage_start_date }} ~ {{ pc.usage_end_date }}
                                {% elif pc.usage_end_date %}
                                    ~ {{ pc.usage_end_date }}
                                {% else %}
                                    <span class="text-muted">ë¯¸ì„¤ì •</span>
                                {% endif %}
                            </td>
                            <td>{{ pc.last_seen_at.split(' ')[0] if pc.last_seen_at else "-" }}</td>
                            <td>
                                {% if pc.display_status == 'APPROVED' %}
                                    <span class="badge bg-success">APPROVED</span>
                                {% elif pc.display_status == 'PENDING' %}
                                    <span class="badge bg-warning">PENDING</span>
                                {% elif pc.display_status == 'EXPIRED' %}
                                    <span class="badge bg-danger">EXPIRED</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ pc.display_status or 'PENDING' }}</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" onclick="showDetailModal('{{ pc.pc_unique_id }}', '{{ pc.bay_display }}', '{{ pc.pc_name }}', '{{ pc.pc_hostname or '' }}', '{{ pc.pc_platform or '' }}', '{{ pc.registered_at or '' }}', '{{ pc.approved_at or '' }}', '{{ pc.usage_start_date or '' }}', '{{ pc.usage_end_date or '' }}')">ìƒì„¸</button>
                                {% if pc.display_status == 'EXPIRED' %}
                                    <button class="btn btn-sm btn-primary ms-1" onclick="requestExtension('{{ pc.pc_unique_id }}', '{{ pc.bay_display }}')">ì‚¬ìš© ê¸°ê°„ ì—°ì¥ ìš”ì²­</button>
                                {% elif pc.display_status == 'PENDING' %}
                                    <span class="badge bg-info ms-1">ì—°ì¥ ìš”ì²­ ì²˜ë¦¬ ì¤‘</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning">
                ë“±ë¡ëœ íƒ€ì„(ë£¸)ì´ ì—†ìŠµë‹ˆë‹¤. ê° íƒ€ì„(ë£¸)ì˜ ì»´í“¨í„°ì—ì„œ <code>register_pc.py</code>ë¥¼ ì‹¤í–‰í•˜ì—¬ ë“±ë¡í•˜ì„¸ìš”.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">PC ìƒì„¸ ì •ë³´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%">íƒ€ì„(ë£¸) ì´ë¦„</th>
                            <td id="detail-pc-name"></td>
                        </tr>
                        <tr>
                            <th>í˜¸ìŠ¤íŠ¸ëª…</th>
                            <td id="detail-hostname"></td>
                        </tr>
                        <tr>
                            <th>í”Œë«í¼</th>
                            <td id="detail-platform"></td>
                        </tr>
                        <tr>
                            <th>PC ê³ ìœ ë²ˆí˜¸</th>
                            <td><code id="detail-unique-id" style="font-size: 0.85rem; word-break: break-all;"></code></td>
                        </tr>
                        <tr>
                            <th>ë“±ë¡ì¼</th>
                            <td id="detail-registered-at"></td>
                        </tr>
                        <tr>
                            <th>ìŠ¹ì¸ì¼</th>
                            <td id="detail-approved-at"></td>
                        </tr>
                        <tr>
                            <th>ì‚¬ìš©ê¸°ê°„</th>
                            <td id="detail-usage-period"></td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì—°ì¥ ìš”ì²­ ëª¨ë‹¬ -->
    <div class="modal fade" id="extensionRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì‚¬ìš© ê¸°ê°„ ì—°ì¥ ìš”ì²­</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong id="extension-pc-name"></strong></p>
                    <div class="mb-3">
                        <label for="requested-until" class="form-label">í¬ë§ ë§Œë£Œì¼</label>
                        <input type="date" class="form-control" id="requested-until" required>
                    </div>
                    <div class="mb-3">
                        <label for="extension-reason" class="form-label">ì‚¬ìœ  (ì„ íƒ)</label>
                        <textarea class="form-control" id="extension-reason" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="submitExtensionRequest()">ìš”ì²­ ì œì¶œ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPcUniqueId = null;
        
        function requestExtension(pcUniqueId, bayName) {
            currentPcUniqueId = pcUniqueId;
            document.getElementById('extension-pc-name').textContent = bayName;
            document.getElementById('requested-until').value = '';
            document.getElementById('extension-reason').value = '';
            new bootstrap.Modal(document.getElementById('extensionRequestModal')).show();
        }
        
        function submitExtensionRequest() {
            const requestedUntil = document.getElementById('requested-until').value;
            const reason = document.getElementById('extension-reason').value;
            
            if (!requestedUntil) {
                alert('í¬ë§ ë§Œë£Œì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            fetch(`/api/pcs/${currentPcUniqueId}/extension-request`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    requested_until: requestedUntil,
                    reason: reason || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ì—°ì¥ ìš”ì²­ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    bootstrap.Modal.getInstance(document.getElementById('extensionRequestModal')).hide();
                    loadExtensionRequests();
                    location.reload();
                } else {
                    alert('ì—°ì¥ ìš”ì²­ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                alert('ì—°ì¥ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error);
            });
        }
        
        function loadExtensionRequests() {
            fetch(`/api/stores/{{ store_id }}/pc-extension-requests`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('extension-requests-container');
                    if (!data.requests || data.requests.length === 0) {
                        container.innerHTML = '<p class="text-muted">ì—°ì¥ ìš”ì²­ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                        return;
                    }
                    
                    let html = '<div class="table-responsive"><table class="table table-sm table-bordered">';
                    html += '<thead><tr><th>PC ID</th><th>ìš”ì²­ ì¼ì‹œ</th><th>ìš”ì²­ ê¸°ê°„</th><th>ìƒíƒœ</th><th>ë°˜ë ¤ ì‚¬ìœ </th></tr></thead><tbody>';
                    
                    data.requests.forEach(req => {
                        const statusClass = {
                            'REQUESTED': 'bg-warning',
                            'APPROVED': 'bg-success',
                            'REJECTED': 'bg-danger'
                        }[req.status] || 'bg-secondary';
                        
                        html += `<tr>
                            <td><code>${req.pc_unique_id || req.pc_id || '-'}</code></td>
                            <td>${req.created_at ? req.created_at.split(' ')[0] : '-'}</td>
                            <td>${req.requested_until || '-'}</td>
                            <td><span class="badge ${statusClass}">${req.status}</span></td>
                            <td>${req.reason || (req.status === 'REJECTED' ? '-' : '')}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                })
                .catch(error => {
                    document.getElementById('extension-requests-container').innerHTML = 
                        '<p class="text-danger">ì—°ì¥ ìš”ì²­ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
                });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ì¥ ìš”ì²­ ì´ë ¥ ë¡œë“œ
        document.addEventListener('DOMContentLoaded', function() {
            loadExtensionRequests();
        });
        
        function showDetailModal(pcUniqueId, bayName, pcName, hostname, platform, registeredAt, approvedAt, usageStartDate, usageEndDate) {
            document.getElementById('detail-pc-name').textContent = pcName || bayName || '-';
            document.getElementById('detail-hostname').textContent = hostname || '-';
            document.getElementById('detail-platform').textContent = platform || '-';
            document.getElementById('detail-unique-id').textContent = pcUniqueId || '-';
            document.getElementById('detail-registered-at').textContent = registeredAt ? registeredAt.split(' ')[0] : '-';
            document.getElementById('detail-approved-at').textContent = approvedAt ? approvedAt.split(' ')[0] : '-';
            
            let usagePeriod = '-';
            if (usageStartDate && usageEndDate) {
                usagePeriod = usageStartDate + ' ~ ' + usageEndDate;
            } else if (usageEndDate) {
                usagePeriod = '~ ' + usageEndDate;
            }
            document.getElementById('detail-usage-period').textContent = usagePeriod;
            
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
    </script>
</body>
</html>
