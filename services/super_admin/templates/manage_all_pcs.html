<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ì²´ ë§¤ì¥ íƒ€ì„(ë£¸) ê´€ë¦¬ - Golf Trainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/super_admin.css') }}">
    <style>
        .status-pending { background-color: #ffc107; color: #000; }
        .status-active { background-color: #28a745; color: #fff; }
        .status-rejected { background-color: #dc3545; color: #fff; }
        .status-expired { background-color: #6c757d; color: #fff; }
        .modal-body input, .modal-body textarea { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="super-container">
        <div class="super-header">
            <h1 class="text-white mb-0">ğŸ¢ ì „ì²´ ë§¤ì¥ íƒ€ì„(ë£¸) ê´€ë¦¬</h1>
        </div>
        
        <div class="super-main-content">
            <div class="mb-3">
                <a href="{{ url_for('super_admin_dashboard') }}" class="super-btn super-btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
            </div>
            
            {% if pcs %}
            <div class="table-responsive">
                <table class="super-table">
                    <thead>
                        <tr>
                            <th>ë§¤ì¥ëª…</th>
                            <th>íƒ€ì„(ë£¸)</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ì‚¬ìš©ê¸°ê°„</th>
                            <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ì—…</th>
                            <th>ìƒì„¸ì •ë³´</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pc in pcs %}
                        <tr>
                            <td><strong style="font-size: 1.1em;">{{ pc.store_name }}</strong></td>
                            <td><strong style="font-size: 1.1em; color: #007bff;">{{ pc.bay_name or pc.bay_display or "-" }}</strong></td>
                            <td>{{ pc.registered_at.split(' ')[0] if pc.registered_at else "-" }}</td>
                            <td>
                                {% if pc.usage_start_date and pc.usage_end_date %}
                                    {{ pc.usage_start_date }} ~ {{ pc.usage_end_date }}
                                {% elif pc.usage_end_date %}
                                    ~ {{ pc.usage_end_date }}
                                {% else %}
                                    <span class="text-muted">ë¯¸ì„¤ì •</span>
                                {% endif %}
                            </td>
                            <td>{{ pc.last_seen_at.split(' ')[0] if pc.last_seen_at else "-" }}</td>
                            <td>
                                <span class="badge status-{{ pc.status or 'pending' }}">
                                    {% if pc.status == 'pending' %}ëŒ€ê¸°
                                    {% elif pc.status == 'active' %}í™œì„±
                                    {% elif pc.status == 'rejected' %}ê±°ë¶€
                                    {% else %}{{ pc.status }}
                                    {% endif %}
                                </span>
                            </td>
                            <td>
                                {% if pc.status == 'pending' %}
                                    <button class="btn btn-sm btn-success" onclick="showApproveModal('{{ pc.pc_unique_id }}', '{{ pc.store_id or '' }}', '{{ pc.store_name }}', '{{ pc.bay_number or pc.bay_id or '' }}', '{{ pc.bay_name or pc.bay_display }}')">ìŠ¹ì¸</button>
                                    <button class="btn btn-sm btn-danger" onclick="showRejectModal('{{ pc.pc_unique_id }}', '{{ pc.store_name }}', '{{ pc.bay_name or pc.bay_display }}')">ê±°ë¶€</button>
                                {% elif pc.status == 'active' %}
                                    <button class="btn btn-sm btn-primary" onclick="showApproveModal('{{ pc.pc_unique_id }}', '{{ pc.store_id or '' }}', '{{ pc.store_name }}', '{{ pc.bay_number or pc.bay_id or '' }}', '{{ pc.bay_name or pc.bay_display }}', '', '{{ pc.usage_start_date or '' }}', '{{ pc.usage_end_date or '' }}', '{{ pc.approved_at or '' }}')">ìˆ˜ì •</button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-danger" onclick="showDeleteModal('{{ pc.pc_unique_id }}', '{{ pc.store_name }}', '{{ pc.bay_name or pc.bay_display }}')">ì‚­ì œ</button>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" onclick="showDetailModal('{{ pc.pc_unique_id }}', '{{ pc.store_name }}', '{{ pc.bay_name or pc.bay_display }}', '{{ pc.pc_hostname or '' }}', '{{ pc.pc_platform or '' }}', '{{ pc.pc_unique_id }}', '{{ pc.registered_at or '' }}', '{{ pc.approved_at or '' }}', '{{ pc.approved_by or '' }}', '{{ pc.notes or '' }}')">ìƒì„¸</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning">
                ë“±ë¡ëœ PCê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ìŠ¹ì¸ ëª¨ë‹¬ -->
    <div class="modal fade" id="approveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">íƒ€ì„(ë£¸) ìŠ¹ì¸</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ë§¤ì¥:</strong> <span id="approve-store-name"></span></p>
                    <p><strong>íƒ€ì„(ë£¸) ì´ë¦„:</strong> <span id="approve-bay-name"></span></p>
                    <hr>
                    <label>íƒ€ì„ ë²ˆí˜¸ (bay_id) <span class="text-danger">*</span>:</label>
                    <input 
                        type="number" 
                        id="approve-bay-id" 
                        class="form-control" 
                        min="1" 
                        step="1" 
                        required
                        placeholder="ì˜ˆ: 1, 2, 3..."
                    >
                    <small class="form-text text-muted">
                        íƒ€ì„ ë²ˆí˜¸(bay_id)ëŠ” ìˆ«ìë§Œ ì…ë ¥í•˜ë©°, 01 ê°™ì€ í˜•ì‹ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                        ì˜ˆ: 1, 2, 3 â€¦
                    </small>
                    <label class="mt-3">ì‚¬ìš© ì‹œì‘ì¼:</label>
                    <input type="date" id="approve-start-date" class="form-control" required>
                    <label>ì‚¬ìš© ì¢…ë£Œì¼:</label>
                    <input type="date" id="approve-end-date" class="form-control" required>
                    <label>ìŠ¹ì¸ì¼ (ì„ íƒ, ë¹„ì›Œë‘ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •):</label>
                    <input type="date" id="approve-approved-date" class="form-control">
                    <label>ë©”ëª¨ (ì„ íƒ):</label>
                    <textarea id="approve-notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-success" onclick="approvePC()">ìŠ¹ì¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ê±°ë¶€ ëª¨ë‹¬ -->
    <div class="modal fade" id="rejectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">íƒ€ì„(ë£¸) ê±°ë¶€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ë§¤ì¥:</strong> <span id="reject-store-name"></span></p>
                    <p><strong>íƒ€ì„(ë£¸):</strong> <span id="reject-bay-name"></span></p>
                    <p><strong>íƒ€ì„(ë£¸):</strong> <span id="reject-pc-name"></span></p>
                    <hr>
                    <label>ê±°ë¶€ ì‚¬ìœ  (ì„ íƒ):</label>
                    <textarea id="reject-notes" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" onclick="rejectPC()">ê±°ë¶€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚­ì œ ëª¨ë‹¬ -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">íƒ€ì„(ë£¸) ì‚­ì œ í™•ì¸</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>âš ï¸ ê²½ê³ :</strong> ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    <p><strong>ë§¤ì¥:</strong> <span id="delete-store-name"></span></p>
                    <p><strong>íƒ€ì„(ë£¸):</strong> <span id="delete-bay-name"></span></p>
                    <p><strong>íƒ€ì„(ë£¸):</strong> <span id="delete-pc-name"></span></p>
                    <hr>
                    <p class="text-danger">
                        ì´ PCë¥¼ ì‚­ì œí•˜ë©´ í•´ë‹¹ ë§¤ì¥ì—ì„œ ì œê±°ë˜ë©°, ë‹¤ì‹œ ë“±ë¡í•˜ë ¤ë©´ PC ë“±ë¡ í”„ë¡œê·¸ë¨ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-danger" onclick="deletePC()">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">PC ìƒì„¸ ì •ë³´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered">
                        <tr>
                            <th width="30%">ë§¤ì¥ëª…</th>
                            <td id="detail-store-name"></td>
                        </tr>
                        <tr>
                            <th>íƒ€ì„(ë£¸)</th>
                            <td id="detail-pc-name"></td>
                        </tr>
                        <tr>
                            <th>í˜¸ìŠ¤íŠ¸ëª…</th>
                            <td id="detail-hostname"></td>
                        </tr>
                        <tr>
                            <th>í”Œë«í¼</th>
                            <td id="detail-platform"></td>
                        </tr>
                        <tr>
                            <th>PC ê³ ìœ ë²ˆí˜¸</th>
                            <td><code id="detail-unique-id" style="font-size: 0.85rem; word-break: break-all;"></code></td>
                        </tr>
                        <tr>
                            <th>ë“±ë¡ì¼</th>
                            <td id="detail-registered-at"></td>
                        </tr>
                        <tr>
                            <th>ìŠ¹ì¸ì¼</th>
                            <td id="detail-approved-at"></td>
                        </tr>
                        <tr>
                            <th>ìŠ¹ì¸ì</th>
                            <td id="detail-approved-by"></td>
                        </tr>
                        <tr>
                            <th>ë©”ëª¨</th>
                            <td id="detail-notes"></td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- bay_id ë³€ê²½ ê²½ê³  ëª¨ë‹¬ -->
    <div class="modal fade" id="bayIdChangeWarningModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">âš ï¸ íƒ€ì„ ë²ˆí˜¸ ë³€ê²½ ê²½ê³ </h5>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>ì£¼ì˜:</strong> PC ë“±ë¡ ì‹œ ì„ íƒëœ íƒ€ì„ ë²ˆí˜¸ì™€ ë‹¤ë¦…ë‹ˆë‹¤.<br>
                        íƒ€ì„ ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ë©´ ì´ PCëŠ” ìƒˆë¡œìš´ íƒ€ì„ìœ¼ë¡œ í™œì„±í™”ë©ë‹ˆë‹¤.<br>
                        ì •ë§ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                    </div>
                    <p><strong>ì›ë˜ íƒ€ì„ ë²ˆí˜¸:</strong> <span id="original-bay-id"></span></p>
                    <p><strong>ë³€ê²½í•˜ë ¤ëŠ” íƒ€ì„ ë²ˆí˜¸:</strong> <span id="new-bay-id"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelBayIdChange()">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-warning" onclick="confirmBayIdChange()">ë³€ê²½ ìœ ì§€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ë°°í¬ í™•ì¸ìš© ë¹Œë“œ ë§ˆì»¤ -->
    <span id="build-marker" data-build="MANAGE_ALL_PCS__2026-01-19__v2" style="display: none;"></span>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // âœ… [6ë‹¨ê³„] ë””ë²„ê·¸ ë¡œê·¸ (í™•ì¸ìš©)
        console.log('[MANAGE_ALL_PCS] bay_id warning FINAL FIX applied');
        console.log('[MANAGE_ALL_PCS] build=MANAGE_ALL_PCS__2026-01-19__v2');
        console.log('[MANAGE_ALL_PCS] Version: 2026-01-19-bay-id-warning-v2');
        
        // âœ… ë¹Œë“œ ë§ˆì»¤ í™•ì¸
        const buildMarker = document.getElementById('build-marker');
        if (buildMarker) {
            console.log('[MANAGE_ALL_PCS] Build marker found:', buildMarker.getAttribute('data-build'));
        } else {
            console.warn('[MANAGE_ALL_PCS] Build marker NOT found!');
        }
        
        // âœ… [1ë‹¨ê³„] ì „ì—­ ìƒíƒœ ë³€ìˆ˜ ëª…í™•íˆ ë¶„ë¦¬
        let currentPcUniqueId = null;
        let currentStoreId = '';
        let currentBayId = '';
        let originalBayId = null;  // PC ë“±ë¡ ì‹œ ì „ë‹¬ëœ ì›ë˜ bay_id ê°’ (ì‹¤ì œë¡œëŠ” bay_number)
        let bayIdInitialized = false;   // ğŸ”´ ìµœì´ˆ 1íšŒ ìë™ì…ë ¥ìš©
        let pendingBayIdChange = null;  // ë³€ê²½ ì‹œë„ ì¤‘ì¸ ê°’
        
        function showApproveModal(pcUniqueId, storeId, storeName, bayId, bayName, startDate = '', endDate = '', approvedDate = '') {
            currentPcUniqueId = pcUniqueId;
            currentStoreId = storeId || '';
            currentBayId = bayId || '';
            
            document.getElementById('approve-store-name').textContent = storeName;
            document.getElementById('approve-bay-name').textContent = bayName;
            
            const bayIdInput = document.getElementById('approve-bay-id');
            
            // âœ… [2ë‹¨ê³„] ìµœì´ˆ 1íšŒë§Œ ìë™ ì„¸íŒ…
            if (!bayIdInitialized) {
                // PC ë“±ë¡ ì‹œ ì „ë‹¬ëœ bay_idë¥¼ ì›ë˜ ê°’ìœ¼ë¡œ ì €ì¥
                if (bayId) {
                    const bayIdInt = parseInt(bayId, 10);
                    originalBayId = (!isNaN(bayIdInt) && bayIdInt > 0) ? bayIdInt : null;
                } else {
                    originalBayId = null;
                }
                
                // bay_id ì…ë ¥ í•„ë“œì— ê¸°ë³¸ê°’ ìë™ ì…ë ¥ (ìµœì´ˆ 1íšŒë§Œ)
                bayIdInput.value = originalBayId !== null ? originalBayId : '';
                bayIdInitialized = true;
                
                console.log('[DEBUG] bay_id initialized:', originalBayId);
            } else {
                console.log('[DEBUG] bay_id already initialized, not overwriting. Current value:', bayIdInput.value);
            }
            
            // âœ… [2ë‹¨ê³„] íƒ€ì„ ë²ˆí˜¸ ìˆ˜ì • ê°ì§€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
            bayIdInput.removeEventListener('change', handleBayIdChange);
            bayIdInput.removeEventListener('blur', handleBayIdBlur);
            
            // change ì´ë²¤íŠ¸: ê°’ ë³€ê²½ ì‹œ ì¦‰ì‹œ ê°ì§€
            bayIdInput.addEventListener('change', handleBayIdChange);
            
            // blur ì´ë²¤íŠ¸: í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ ê°ì§€
            bayIdInput.addEventListener('blur', handleBayIdBlur);
            
            const today = new Date().toISOString().split('T')[0];
            const oneYearLater = new Date();
            oneYearLater.setFullYear(oneYearLater.getFullYear() + 1);
            const oneYearLaterStr = oneYearLater.toISOString().split('T')[0];
            
            document.getElementById('approve-start-date').value = startDate || today;
            document.getElementById('approve-end-date').value = endDate || oneYearLaterStr;
            document.getElementById('approve-approved-date').value = approvedDate || today;
            document.getElementById('approve-notes').value = '';
            
            const approveModal = new bootstrap.Modal(document.getElementById('approveModal'));
            approveModal.show();
            
            // âœ… [5ë‹¨ê³„] ëª¨ë‹¬ ë‹«í ë•Œ ìƒíƒœ ì´ˆê¸°í™”
            const approveModalElement = document.getElementById('approveModal');
            approveModalElement.addEventListener('hidden.bs.modal', function onModalHidden() {
                bayIdInitialized = false;
                originalBayId = null;
                pendingBayIdChange = null;
                console.log('[DEBUG] Modal closed, state reset');
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                approveModalElement.removeEventListener('hidden.bs.modal', onModalHidden);
            }, { once: true });
        }
        
        // âœ… [3ë‹¨ê³„] bay_id ë³€ê²½ ê°ì§€ ë¡œì§ ìˆ˜ì •
        function handleBayIdChange(event) {
            const bayIdInput = event.target;
            const current = parseInt(bayIdInput.value.trim(), 10);
            
            // originalBayIdê°€ ì—†ìœ¼ë©´ ë¬´ì‹œ
            if (originalBayId === null) {
                return;
            }
            
            // ìˆ«ìê°€ ì•„ë‹ˆê±°ë‚˜ 0 ì´í•˜ë©´ ë¬´ì‹œ
            if (isNaN(current) || current <= 0) {
                return;
            }
            
            // âœ… ì›ë˜ ê°’ê³¼ ë‹¤ë¥¸ ê²½ìš°ì—ë§Œ ê²½ê³  ëª¨ë‹¬ í‘œì‹œ
            // ë‹¨, ê²½ê³  ëª¨ë‹¬ì´ ì´ë¯¸ ì—´ë ¤ìˆì§€ ì•Šì€ ê²½ìš°ì—ë§Œ í‘œì‹œ (ì¤‘ë³µ ë°©ì§€)
            if (current !== originalBayId) {
                const warningModal = bootstrap.Modal.getInstance(document.getElementById('bayIdChangeWarningModal'));
                const isWarningModalOpen = warningModal && warningModal._element && warningModal._element.classList.contains('show');
                
                if (!isWarningModalOpen) {
                    pendingBayIdChange = current;
                    showBayIdChangeWarning(originalBayId, current);
                }
            }
        }
        
        // âœ… [2ë‹¨ê³„] blur ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚  ë•Œ)
        function handleBayIdBlur(event) {
            // change ì´ë²¤íŠ¸ì—ì„œ ì´ë¯¸ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì¶”ê°€ ì²˜ë¦¬ ì—†ìŒ
            // ë‹¨, change ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ í•œ ë²ˆ ë” ì²´í¬
            handleBayIdChange(event);
        }
        
        // âœ… [3ë‹¨ê³„] ê²½ê³  ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showBayIdChangeWarning(originalValue, newValue) {
            document.getElementById('original-bay-id').textContent = originalValue || 'ì—†ìŒ';
            document.getElementById('new-bay-id').textContent = newValue;
            
            const warningModal = new bootstrap.Modal(document.getElementById('bayIdChangeWarningModal'));
            warningModal.show();
        }
        
        // âœ… [4ë‹¨ê³„] ê²½ê³  ëª¨ë‹¬ ë²„íŠ¼ ë™ì‘ ëª…í™•í™”
        // ì·¨ì†Œ ë²„íŠ¼
        function cancelBayIdChange() {
            const bayIdInput = document.getElementById('approve-bay-id');
            bayIdInput.value = originalBayId !== null ? originalBayId : '';
            pendingBayIdChange = null;
            
            // ê²½ê³  ëª¨ë‹¬ ë‹«ê¸°
            const warningModal = bootstrap.Modal.getInstance(document.getElementById('bayIdChangeWarningModal'));
            if (warningModal) {
                warningModal.hide();
            }
        }
        
        // ë³€ê²½ ìœ ì§€ ë²„íŠ¼
        function confirmBayIdChange() {
            // ê°’ ìœ ì§€, ì•„ë¬´ ê²ƒë„ ë®ì–´ì“°ì§€ ì•ŠìŒ
            pendingBayIdChange = null;
            
            // ê²½ê³  ëª¨ë‹¬ ë‹«ê¸°
            const warningModal = bootstrap.Modal.getInstance(document.getElementById('bayIdChangeWarningModal'));
            if (warningModal) {
                warningModal.hide();
            }
            
            // ìŠ¹ì¸ ëª¨ë‹¬ì˜ bay_id inputì— í¬ì»¤ìŠ¤ (ì‚¬ìš©ìê°€ í™•ì¸í•  ìˆ˜ ìˆë„ë¡)
            document.getElementById('approve-bay-id').focus();
        }

        function showRejectModal(pcUniqueId, storeName, bayName) {
            currentPcUniqueId = pcUniqueId;
            document.getElementById('reject-store-name').textContent = storeName;
            document.getElementById('reject-bay-name').textContent = bayName;
            document.getElementById('reject-pc-name').textContent = bayName || '-';
            document.getElementById('reject-notes').value = '';
            
            new bootstrap.Modal(document.getElementById('rejectModal')).show();
        }

        function approvePC() {
            const bayIdInput = document.getElementById('approve-bay-id');
            const bayIdValue = bayIdInput.value.trim();
            const startDate = document.getElementById('approve-start-date').value;
            const endDate = document.getElementById('approve-end-date').value;
            const approvedDate = document.getElementById('approve-approved-date').value;
            const notes = document.getElementById('approve-notes').value;
            
            // bay_id í•„ìˆ˜ ê²€ì¦
            if (!bayIdValue) {
                alert('íƒ€ì„ ë²ˆí˜¸(bay_id)ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.');
                bayIdInput.focus();
                return;
            }
            
            // ìˆ«ì ê²€ì¦
            if (!/^\d+$/.test(bayIdValue)) {
                alert('íƒ€ì„ ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                bayIdInput.focus();
                return;
            }
            
            const bayIdInt = parseInt(bayIdValue, 10);
            if (bayIdInt <= 0) {
                alert('íƒ€ì„ ë²ˆí˜¸ëŠ” 1 ì´ìƒì˜ ì •ìˆ˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                bayIdInput.focus();
                return;
            }
            
            if (!startDate || !endDate) {
                alert('ì‚¬ìš© ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // bay_idëŠ” ì •ìˆ˜ë¡œ ì „ì†¡ (01 ì…ë ¥ ì‹œ ìë™ìœ¼ë¡œ 1 ì²˜ë¦¬)
            const requestBody = {
                pc_unique_id: currentPcUniqueId,
                store_id: currentStoreId || null,
                bay_id: bayIdInt,  // ì •ìˆ˜ë¡œ ì „ì†¡
                usage_start_date: startDate,
                usage_end_date: endDate,
                approved_date: approvedDate || new Date().toISOString().split('T')[0],
                notes: notes
            };
            
            console.log('ìŠ¹ì¸ ìš”ì²­ ë°ì´í„°:', requestBody);
            
            fetch('{{ url_for("approve_pc") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                if (!response.ok) {
                    return response.json().then(err => Promise.reject(err));
                }
                return response.json();
            })
            .then(data => {
                console.log('ìŠ¹ì¸ ì‘ë‹µ:', data);
                if (data.success) {
                    alert('íƒ€ì„(ë£¸) ìŠ¹ì¸ ì™„ë£Œ');
                    location.reload();
                } else {
                    alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                console.error('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            });
        }

        function rejectPC() {
            const notes = document.getElementById('reject-notes').value;
            
            fetch('{{ url_for("reject_pc") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pc_unique_id: currentPcUniqueId,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('íƒ€ì„(ë£¸) ê±°ë¶€ ì™„ë£Œ');
                    location.reload();
                } else {
                    alert('ê±°ë¶€ ì‹¤íŒ¨: ' + data.message);
                }
            });
        }

        function showDeleteModal(pcUniqueId, storeName, bayName) {
            currentPcUniqueId = pcUniqueId;
            document.getElementById('delete-store-name').textContent = storeName;
            document.getElementById('delete-bay-name').textContent = bayName;
            document.getElementById('delete-pc-name').textContent = bayName || '-';
            
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }

        function deletePC() {
            if (!confirm('ì •ë§ë¡œ ì´ PCë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            fetch('{{ url_for("delete_pc") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pc_unique_id: currentPcUniqueId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('PC ì‚­ì œ ì™„ë£Œ');
                    location.reload();
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function showDetailModal(pcUniqueId, storeName, bayName, hostname, platform, uniqueId, registeredAt, approvedAt, approvedBy, notes) {
            document.getElementById('detail-store-name').textContent = storeName || '-';
            document.getElementById('detail-pc-name').textContent = bayName || '-';
            document.getElementById('detail-hostname').textContent = hostname || '-';
            document.getElementById('detail-platform').textContent = platform || '-';
            document.getElementById('detail-unique-id').textContent = uniqueId || '-';
            document.getElementById('detail-registered-at').textContent = registeredAt ? registeredAt.split(' ')[0] : '-';
            document.getElementById('detail-approved-at').textContent = approvedAt ? approvedAt.split(' ')[0] : '-';
            document.getElementById('detail-approved-by').textContent = approvedBy || '-';
            document.getElementById('detail-notes').textContent = notes || '-';
            
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }
    </script>
</body>
</html>
