<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¥ ë“±ë¡ ìš”ì²­ ê´€ë¦¬ - Golf Trainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/super_admin.css') }}">
    <style>
        .search-filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .code-generator-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #0d6efd;
        }
        .code-display {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
            padding: 10px;
            background: white;
            border-radius: 4px;
            text-align: center;
            margin: 10px 0;
        }
        .store-list-section {
            margin-bottom: 30px;
        }
        .store-list-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0d6efd;
        }
        .badge-count {
            background: #0d6efd;
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 14px;
        }
        .super-table {
            width: 100%;
            border-collapse: collapse;
        }
        .super-table th,
        .super-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .super-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            white-space: nowrap;
        }
        .super-table tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="super-container">
        <div class="super-header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="text-white mb-0">ğŸ“‹ ë§¤ì¥ ë“±ë¡ ìš”ì²­ ê´€ë¦¬</h1>
                <a href="{{ url_for('super_admin_dashboard') }}" class="super-btn super-btn-secondary">â† ëŒ€ì‹œë³´ë“œ</a>
            </div>
        </div>
        
        <div class="super-main-content">
            <!-- ë“±ë¡ ì½”ë“œ ìƒì„±ê¸° -->
            <div class="code-generator-section">
                <h3>ğŸ”‘ íƒ€ì„(ë£¸) ë“±ë¡ ì½”ë“œ ìƒì„±ê¸°</h3>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-primary btn-lg w-100" onclick="generateCode()">
                            ìƒˆ ë“±ë¡ ì½”ë“œ ìƒì„±
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div id="codeDisplay" class="code-display" style="display:none;">
                            <span id="generatedCode"></span>
                        </div>
                    </div>
                </div>
                <div id="codeMessage" class="mt-2"></div>
            </div>

            <!-- ê²€ìƒ‰ ë° í•„í„° -->
            <div class="search-filter-section">
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">ë§¤ì¥ ê²€ìƒ‰</label>
                        <input type="text" id="searchInput" class="form-control" placeholder="ë§¤ì¥ëª… ë˜ëŠ” ì½”ë“œë¡œ ê²€ìƒ‰..." onkeyup="filterStores()">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ì •ë ¬ ê¸°ì¤€</label>
                        <select id="sortSelect" class="form-select" onchange="sortStores()">
                            <option value="requested_at_desc">ìš”ì²­ì¼ (ìµœì‹ ìˆœ)</option>
                            <option value="requested_at_asc">ìš”ì²­ì¼ (ì˜¤ë˜ëœìˆœ)</option>
                            <option value="store_name_asc">ë§¤ì¥ëª… (ê°€ë‚˜ë‹¤ìˆœ)</option>
                            <option value="store_id_asc">ë§¤ì¥ ì½”ë“œ (ì˜¤ë¦„ì°¨ìˆœ)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">ìƒíƒœ í•„í„°</label>
                        <select id="statusFilter" class="form-select" onchange="filterStores()">
                            <option value="all">ì „ì²´</option>
                            <option value="pending">ìŠ¹ì¸ ëŒ€ê¸°</option>
                            <option value="approved">ìŠ¹ì¸ ì™„ë£Œ</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ë§¤ì¥ -->
            <div class="store-list-section">
                <h3 class="store-list-title">
                    â³ ë“±ë¡ ëŒ€ê¸°ì¤‘ ë¦¬ìŠ¤íŠ¸ 
                    <span class="badge-count">{{ pending_stores|length }}ê±´</span>
                </h3>
                <div id="pendingStoresTable">
                    {% if pending_stores and pending_stores|length > 0 %}
                    <div class="table-responsive">
                        <table class="super-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 120px;">ë§¤ì¥ ì½”ë“œ</th>
                                    <th style="min-width: 150px;">ë§¤ì¥ ì´ë¦„</th>
                                    <th style="min-width: 80px;">íƒ€ì„ ìˆ˜</th>
                                    <th style="min-width: 100px;">ìš”ì²­ì¼</th>
                                    <th style="min-width: 150px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="pendingStoresBody">
                                {% for store in pending_stores %}
                                <tr data-store-id="{{ store.store_id }}" data-store-name="{{ store.store_name or '' }}" data-requested-at="{{ store.requested_at or '' }}">
                                    <td><strong>{{ store.store_id }}</strong></td>
                                    <td>{{ store.store_name or '-' }}</td>
                                    <td>{{ store.bays_count }}ê°œ</td>
                                    <td>{{ store.requested_at.split(' ')[0] if store.requested_at else '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="approveStore('{{ store.store_id }}')">
                                            ìŠ¹ì¸
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="rejectStore('{{ store.store_id }}')">
                                            ê±°ë¶€
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ë§¤ì¥ ë“±ë¡ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- ìŠ¹ì¸ ì™„ë£Œëœ ë§¤ì¥ -->
            <div class="store-list-section">
                <h3 class="store-list-title">
                    âœ… ë“±ë¡ëœ ë¦¬ìŠ¤íŠ¸ 
                    <span class="badge-count">{{ approved_stores|length }}ê±´</span>
                </h3>
                <div id="approvedStoresTable">
                    {% if approved_stores and approved_stores|length > 0 %}
                    <div class="table-responsive">
                        <table class="super-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 120px;">ë§¤ì¥ ì½”ë“œ</th>
                                    <th style="min-width: 150px;">ë§¤ì¥ ì´ë¦„</th>
                                    <th style="min-width: 80px;">íƒ€ì„ ìˆ˜</th>
                                    <th style="min-width: 100px;">ìš”ì²­ì¼</th>
                                    <th style="min-width: 100px;">ìŠ¹ì¸ì¼</th>
                                    <th style="min-width: 100px;">ìŠ¹ì¸ì</th>
                                    <th style="min-width: 100px;">ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="approvedStoresBody">
                                {% for store in approved_stores %}
                                <tr data-store-id="{{ store.store_id }}" data-store-name="{{ store.store_name or '' }}" data-requested-at="{{ store.requested_at or '' }}" data-approved-at="{{ store.approved_at or '' }}">
                                    <td><strong>{{ store.store_id }}</strong></td>
                                    <td>{{ store.store_name or '-' }}</td>
                                    <td>{{ store.bays_count }}ê°œ</td>
                                    <td>{{ store.requested_at.split(' ')[0] if store.requested_at else '-' }}</td>
                                    <td>{{ store.approved_at.split(' ')[0] if store.approved_at else '-' }}</td>
                                    <td>{{ store.approved_by or '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteStore('{{ store.store_id }}')">
                                            ì‚­ì œ
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        ìŠ¹ì¸ ì™„ë£Œëœ ë§¤ì¥ì´ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ë“±ë¡ ì½”ë“œ ìƒì„±
        let messageTimeout = null;
        
        function generateCode() {
            const btn = event.target;
            btn.disabled = true;
            btn.textContent = 'ìƒì„± ì¤‘...';
            
            // ì´ì „ ë©”ì‹œì§€ íƒ€ì´ë¨¸ ì·¨ì†Œ
            if (messageTimeout) {
                clearTimeout(messageTimeout);
                messageTimeout = null;
            }
            
            fetch('{{ url_for("create_registration_code") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response) {
                    throw new Error('ì„œë²„ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || `API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                    }).catch(() => {
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                    });
                }
                return response.json().catch(() => {
                    throw new Error('ì‘ë‹µ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                });
            })
            .then(data => {
                if (!data) {
                    throw new Error('ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
                btn.disabled = false;
                btn.textContent = 'ìƒˆ ë“±ë¡ ì½”ë“œ ìƒì„±';
                
                if (data.success) {
                    document.getElementById('generatedCode').textContent = data.registration_code;
                    document.getElementById('codeDisplay').style.display = 'block';
                    document.getElementById('codeMessage').innerHTML = 
                        '<div class="alert alert-success">ë“±ë¡ ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                    
                    // 5ì´ˆ í›„ ë©”ì‹œì§€ ì œê±° (ì„±ê³µ ë©”ì‹œì§€ë§Œ)
                    messageTimeout = setTimeout(() => {
                        document.getElementById('codeMessage').innerHTML = '';
                        messageTimeout = null;
                    }, 5000);
                } else {
                    let errorMsg = data.message || data.error || 'ì½”ë“œ ìƒì„± ì‹¤íŒ¨';
                    if (errorMsg.includes('401') || errorMsg.includes('ì¸ì¦')) {
                        errorMsg = 'ì¸ì¦ ì˜¤ë¥˜: Railway í™˜ê²½ ë³€ìˆ˜(SUPER_ADMIN_USERNAME, SUPER_ADMIN_PASSWORD)ë¥¼ golf-apiì™€ golf-super-admin ì„œë¹„ìŠ¤ì— ëª¨ë‘ ë™ì¼í•˜ê²Œ ì„¤ì •í•˜ì„¸ìš”.';
                    }
                    document.getElementById('codeMessage').innerHTML = 
                        '<div class="alert alert-danger">ì˜¤ë¥˜: ' + errorMsg + '</div>';
                    // ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ì§€ ì•ŠìŒ
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.textContent = 'ìƒˆ ë“±ë¡ ì½”ë“œ ìƒì„±';
                let errorMsg = error.message || error.toString();
                if (errorMsg.includes('401') || errorMsg.includes('ì¸ì¦')) {
                    errorMsg = 'ì¸ì¦ ì˜¤ë¥˜: Railway í™˜ê²½ ë³€ìˆ˜(SUPER_ADMIN_USERNAME, SUPER_ADMIN_PASSWORD)ê°€ golf-apiì™€ golf-super-admin ì„œë¹„ìŠ¤ì— ëª¨ë‘ ì„¤ì •ë˜ì–´ ìˆê³  ë™ì¼í•´ì•¼ í•©ë‹ˆë‹¤.';
                }
                document.getElementById('codeMessage').innerHTML = 
                    '<div class="alert alert-danger">ì˜¤ë¥˜: ' + errorMsg + '</div>';
                // ì˜¤ë¥˜ ë©”ì‹œì§€ëŠ” ìë™ìœ¼ë¡œ ì‚¬ë¼ì§€ì§€ ì•ŠìŒ
            });
        }

        // ë§¤ì¥ í•„í„°ë§
        function filterStores() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ í•„í„°ë§
            const pendingRows = document.querySelectorAll('#pendingStoresBody tr');
            pendingRows.forEach(row => {
                const storeId = row.getAttribute('data-store-id').toLowerCase();
                const storeName = (row.getAttribute('data-store-name') || '').toLowerCase();
                const matchesSearch = !searchText || storeId.includes(searchText) || storeName.includes(searchText);
                const matchesStatus = statusFilter === 'all' || statusFilter === 'pending';
                
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
            
            // ìŠ¹ì¸ ì™„ë£Œ ëª©ë¡ í•„í„°ë§
            const approvedRows = document.querySelectorAll('#approvedStoresBody tr');
            approvedRows.forEach(row => {
                const storeId = row.getAttribute('data-store-id').toLowerCase();
                const storeName = (row.getAttribute('data-store-name') || '').toLowerCase();
                const matchesSearch = !searchText || storeId.includes(searchText) || storeName.includes(searchText);
                const matchesStatus = statusFilter === 'all' || statusFilter === 'approved';
                
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        }

        // ë§¤ì¥ ì •ë ¬
        function sortStores() {
            const sortValue = document.getElementById('sortSelect').value;
            const [field, order] = sortValue.split('_');
            
            // ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡ ì •ë ¬
            const pendingBody = document.getElementById('pendingStoresBody');
            if (pendingBody) {
                const rows = Array.from(pendingBody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    let aVal, bVal;
                    
                    if (field === 'requested_at') {
                        aVal = a.getAttribute('data-requested-at') || '';
                        bVal = b.getAttribute('data-requested-at') || '';
                    } else if (field === 'store_name') {
                        aVal = (a.getAttribute('data-store-name') || '').toLowerCase();
                        bVal = (b.getAttribute('data-store-name') || '').toLowerCase();
                    } else if (field === 'store_id') {
                        aVal = a.getAttribute('data-store-id').toLowerCase();
                        bVal = b.getAttribute('data-store-id').toLowerCase();
                    }
                    
                    if (order === 'asc') {
                        return aVal > bVal ? 1 : (aVal < bVal ? -1 : 0);
                    } else {
                        return aVal < bVal ? 1 : (aVal > bVal ? -1 : 0);
                    }
                });
                
                rows.forEach(row => pendingBody.appendChild(row));
            }
            
            // ìŠ¹ì¸ ì™„ë£Œ ëª©ë¡ ì •ë ¬
            const approvedBody = document.getElementById('approvedStoresBody');
            if (approvedBody) {
                const rows = Array.from(approvedBody.querySelectorAll('tr'));
                rows.sort((a, b) => {
                    let aVal, bVal;
                    
                    if (field === 'requested_at') {
                        aVal = a.getAttribute('data-requested-at') || '';
                        bVal = b.getAttribute('data-requested-at') || '';
                    } else if (field === 'store_name') {
                        aVal = (a.getAttribute('data-store-name') || '').toLowerCase();
                        bVal = (b.getAttribute('data-store-name') || '').toLowerCase();
                    } else if (field === 'store_id') {
                        aVal = a.getAttribute('data-store-id').toLowerCase();
                        bVal = b.getAttribute('data-store-id').toLowerCase();
                    }
                    
                    if (order === 'asc') {
                        return aVal > bVal ? 1 : (aVal < bVal ? -1 : 0);
                    } else {
                        return aVal < bVal ? 1 : (aVal > bVal ? -1 : 0);
                    }
                });
                
                rows.forEach(row => approvedBody.appendChild(row));
            }
        }

        // ë§¤ì¥ ìŠ¹ì¸
        function approveStore(storeId) {
            if (confirm(`ë§¤ì¥ '${storeId}'ë¥¼ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch('{{ url_for("approve_store") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({store_id: storeId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ë§¤ì¥ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    } else {
                        alert('ìŠ¹ì¸ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(error => {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
                });
            }
        }
        
        // ë§¤ì¥ ê±°ë¶€
        function rejectStore(storeId) {
            if (confirm(`ë§¤ì¥ '${storeId}'ë¥¼ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                fetch('{{ url_for("reject_store") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({store_id: storeId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ë§¤ì¥ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    } else {
                        alert('ê±°ë¶€ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(error => {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
                });
            }
        }
        
        // ë§¤ì¥ ì‚­ì œ
        function deleteStore(storeId) {
            if (confirm(`ë§¤ì¥ '${storeId}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nê²½ê³ : ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ë§¤ì¥ì˜ ëª¨ë“  ë°ì´í„°(íƒ€ì„, ìƒ· ê¸°ë¡ ë“±)ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                fetch('{{ url_for("delete_store") }}', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({store_id: storeId})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('ë§¤ì¥ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        location.reload();
                    } else {
                        alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(error => {
                    alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
                });
            }
        }
    </script>
</body>
</html>
