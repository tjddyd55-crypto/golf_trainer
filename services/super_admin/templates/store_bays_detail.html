<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ store.store_name or store.store_id }} íƒ€ì„(ë£¸) í˜„í™© - Golf Trainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/super_admin.css') }}?v=2.0">
    <style>
        .bay-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        .bay-card.bay-valid {
            border-left: 4px solid #28a745;
        }
        .bay-card.bay-invalid {
            border-left: 4px solid #ffc107;
            opacity: 0.8;
        }
        .bay-card.bay-no-pc {
            border-left: 4px solid #6c757d;
        }
    </style>
</head>
<body>
    <div class="super-container">
        <div class="super-header">
            <h1 class="text-white mb-0">ğŸ¢ {{ store.store_name or store.store_id }} íƒ€ì„(ë£¸) í˜„í™©</h1>
        </div>
        
        <div class="super-main-content">
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <a href="{{ url_for('super_admin_dashboard') }}" class="super-btn super-btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
                <div>
                    <label for="store-select" class="me-2">ë§¤ì¥ ì„ íƒ:</label>
                    <select id="store-select" class="form-select d-inline-block" style="width: auto;" onchange="if(this.value) location.href='/stores/' + this.value + '/bays'">
                        <option value="">ë§¤ì¥ ì„ íƒ</option>
                        {% for s in all_stores %}
                        <option value="{{ s.store_id }}" {% if s.store_id == store.store_id %}selected{% endif %}>
                            {{ s.store_name or s.store_id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="mb-4">
                <h4>{{ store.store_name or store.store_id }}</h4>
                <div class="mt-2">
                    <span class="badge bg-success me-2">ìœ íš¨: {{ valid_bays_count }}ê°œ</span>
                    <span class="badge bg-warning me-2">ë¬´íš¨: {{ total_bays_count - valid_bays_count }}ê°œ</span>
                    <span class="badge bg-secondary">ì „ì²´: {{ total_bays_count }}ê°œ</span>
                </div>
            </div>
            
            <div class="row">
                {% for bay in bays %}
                <div class="col-md-6 col-lg-4">
                    <div class="bay-card {% if bay.is_valid %}bay-valid{% elif bay.has_pc %}bay-invalid{% else %}bay-no-pc{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">{{ bay.pc_name or (bay.bay_id + 'ë²ˆ íƒ€ì„(ë£¸)') }}</h5>
                            {% if bay.is_valid %}
                            <span class="badge bg-success">âœ“ ìœ íš¨</span>
                            {% elif bay.has_pc %}
                            <span class="badge bg-warning">âš  ë¬´íš¨</span>
                            {% else %}
                            <span class="badge bg-secondary">íƒ€ì„(ë£¸) ë¯¸ë“±ë¡</span>
                            {% endif %}
                        </div>
                        
                        {% if bay.has_pc %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <strong>ìƒíƒœ:</strong> 
                                {% if bay.pc_status == 'pending' %}ìŠ¹ì¸ ëŒ€ê¸° ì¤‘
                                {% elif bay.pc_status == 'rejected' %}ìŠ¹ì¸ ê±°ë¶€ë¨
                                {% elif bay.pc_status == 'active' %}í™œì„±
                                {% else %}{{ bay.pc_status }}
                                {% endif %}
                            </small>
                        </div>
                        
                        {% if bay.usage_start_date or bay.usage_end_date %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <strong>ì‚¬ìš© ê¸°ê°„:</strong><br>
                                {% if bay.usage_start_date %}{{ bay.usage_start_date }}{% else %}-{% endif %} ~ 
                                {% if bay.usage_end_date %}{{ bay.usage_end_date }}{% else %}ë¬´ì œí•œ{% endif %}
                            </small>
                        </div>
                        {% endif %}
                        
                        {% if bay.approved_at %}
                        <div class="mb-2">
                            <small class="text-muted">
                                <strong>ìŠ¹ì¸ì¼:</strong> {{ bay.approved_at.split(' ')[0] if bay.approved_at else '-' }}
                            </small>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <div class="mt-3">
                            <button class="btn btn-sm btn-primary" 
                                    onclick="editBay('{{ bay.bay_id }}', '{{ bay.pc_unique_id or '' }}', '{{ bay.pc_name or '' }}', '{{ bay.usage_start_date or '' }}', '{{ bay.usage_end_date or '' }}', '{{ bay.pc_status or '' }}')">
                                ê¸°ê°„ ì„¤ì • / ìƒíƒœ ë³€ê²½
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- íƒ€ì„ ì„¤ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="bayEditModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">íƒ€ì„(ë£¸) ì„¤ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>íƒ€ì„(ë£¸):</strong> <span id="edit-bay-id"></span></p>
                    <p><strong>íƒ€ì„(ë£¸) ì´ë¦„:</strong> <span id="edit-pc-name"></span></p>
                    <hr>
                    <div class="mb-3">
                        <label>ì‚¬ìš© ì‹œì‘ì¼:</label>
                        <input type="date" id="edit-start-date" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>ì‚¬ìš© ì¢…ë£Œì¼:</label>
                        <input type="date" id="edit-end-date" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label>ìƒíƒœ:</label>
                        <select id="edit-status" class="form-select">
                            <option value="pending">ìŠ¹ì¸ ëŒ€ê¸°</option>
                            <option value="active">í™œì„±</option>
                            <option value="rejected">ê±°ë¶€</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>ë©”ëª¨:</label>
                        <textarea id="edit-notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary" onclick="saveBaySettings()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function selectStore(storeId) {
            if (storeId) {
                location.href = '/stores/' + storeId + '/bays';
            }
        }
        
        let currentBayId = '';
        let currentPcUniqueId = '';
        
        function editBay(bayId, pcUniqueId, pcName, startDate, endDate, status) {
            currentBayId = bayId;
            currentPcUniqueId = pcUniqueId;
            
            document.getElementById('edit-bay-id').textContent = bayId + 'ë²ˆ íƒ€ì„(ë£¸)';
            document.getElementById('edit-pc-name').textContent = pcName || 'íƒ€ì„(ë£¸) ë¯¸ë“±ë¡';
            document.getElementById('edit-start-date').value = startDate || '';
            document.getElementById('edit-end-date').value = endDate || '';
            document.getElementById('edit-status').value = status || 'pending';
            document.getElementById('edit-notes').value = '';
            
            new bootstrap.Modal(document.getElementById('bayEditModal')).show();
        }
        
        function saveBaySettings() {
            const startDate = document.getElementById('edit-start-date').value;
            const endDate = document.getElementById('edit-end-date').value;
            const status = document.getElementById('edit-status').value;
            const notes = document.getElementById('edit-notes').value;
            
            if (!currentPcUniqueId) {
                alert('íƒ€ì„(ë£¸)ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë¨¼ì € íƒ€ì„(ë£¸)ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            fetch('{{ url_for("update_bay_settings") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    pc_unique_id: currentPcUniqueId,
                    bay_id: currentBayId,
                    store_id: '{{ store.store_id }}',
                    usage_start_date: startDate,
                    usage_end_date: endDate,
                    status: status,
                    notes: notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('íƒ€ì„ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            })
            .catch(error => {
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + error);
            });
        }
    </script>
</body>
</html>
