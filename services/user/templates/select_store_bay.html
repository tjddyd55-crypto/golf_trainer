<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¥/íƒ€ì„ ì„ íƒ - Golf Trainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
</head>
<body>
    <div class="user-login-container">
        <div class="user-login-card">
            <h2 class="user-login-title">ğŸŒï¸ ë§¤ì¥/íƒ€ì„ ì„ íƒ</h2>
            
            {% if error %}
            <div class="user-login-error">
                {{ error }}
            </div>
            {% endif %}
            
            <form method="POST" id="selectForm">
                <div class="user-login-form-group">
                    <label class="user-login-label">ë§¤ì¥ ì„ íƒ</label>
                    <select name="store_id" id="storeSelect" class="user-login-input" required>
                        <option value="">ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for store in stores %}
                        <option value="{{ store.store_id }}" {% if selected_store_id == store.store_id %}selected{% endif %}>
                            {{ store.store_name or store.store_id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="user-login-form-group">
                    <label class="user-login-label">íƒ€ì„ ì„ íƒ</label>
                    <select name="bay_id" id="baySelect" class="user-login-input" required>
                        <option value="">ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <button type="submit" class="user-login-button">í™•ì¸</button>
            </form>
            
            <div id="statusMessage" class="user-mt-3">
                <div class="alert alert-info" id="statusBox" style="display: none;">
                    <strong id="statusText"></strong>
                </div>
            </div>
            
            <!-- í˜„ì¬ ìƒí™© í‘œì‹œ ì˜ì—­ -->
            <div id="currentStatus" class="user-mt-3" style="display: none;">
                <div class="alert alert-success">
                    <strong>ğŸ“ í˜„ì¬ ìƒí™©:</strong>
                    <div id="currentStatusText"></div>
                </div>
            </div>
            
            <div class="user-text-center user-mt-3">
                <a href="{{ url_for('logout') }}" class="user-btn user-btn-secondary">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
    
    <script>
        const storeSelect = document.getElementById('storeSelect');
        const baySelect = document.getElementById('baySelect');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        
        // ë§¤ì¥ ì„ íƒ ì‹œ íƒ€ì„ ëª©ë¡ ë¡œë“œ
        storeSelect.addEventListener('change', function() {
            const storeId = this.value;
            baySelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';
            
            if (!storeId) {
                baySelect.innerHTML = '<option value="">ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }
            
            // íƒ€ì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨í•˜ê²Œ 1~5ë²ˆ íƒ€ì„)
            fetch(`/api/get_bays?store_id=${storeId}`)
                .then(response => {
                    if (!response.ok) {
                        // HTTP ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
                        if (response.status === 401) {
                            alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                            window.location.href = '/login';
                            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                        } else if (response.status === 403) {
                            alert('âš ï¸ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                            throw new Error('ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤');
                        } else if (response.status >= 500) {
                            alert('âš ï¸ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                            throw new Error('ì„œë²„ ì˜¤ë¥˜');
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
                    console.log('[DEBUG] get_bays API ì‘ë‹µ:', data);
                    if (data._debug) {
                        console.log('[DEBUG] íƒ€ì„ ì¡°íšŒ ì •ë³´:', data._debug);
                    }
                    
                    baySelect.innerHTML = '<option value="">íƒ€ì„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    if (data.bays && data.bays.length > 0) {
                        console.log('[DEBUG] ì¡°íšŒëœ íƒ€ì„ ê°œìˆ˜:', data.bays.length);
                        data.bays.forEach(bay => {
                            const option = document.createElement('option');
                            option.value = bay.bay_id;
                            // bay_nameì´ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš© (PC ë“±ë¡ ì‹œ ì…ë ¥í•œ ê°’), ì—†ìœ¼ë©´ bay_id ì‚¬ìš©
                            if (bay.bay_name && bay.bay_name.trim()) {
                                option.textContent = bay.bay_name;
                            } else {
                                // bay_nameì´ ì—†ìœ¼ë©´ bay_id ì‚¬ìš©
                                const bayIdStr = String(bay.bay_id);
                                if (bayIdStr.match(/^\d+$/)) {
                                    // ìˆ«ì íƒ€ì„ ID: "03ë²ˆ íƒ€ì„" í˜•ì‹
                                    option.textContent = `${parseInt(bayIdStr)}ë²ˆ íƒ€ì„`;
                                } else {
                                    // ë¬¸ìì—´ íƒ€ì„ ID: "ëŠ¥ë™ì¡í…ŒìŠ¤íŠ¸" í˜•ì‹
                                    option.textContent = bayIdStr;
                                }
                            }
                            baySelect.appendChild(option);
                        });
                    } else {
                        // ìŠ¹ì¸ëœ íƒ€ì„ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'ìŠ¹ì¸ëœ íƒ€ì„ì´ ì—†ìŠµë‹ˆë‹¤';
                        option.disabled = true;
                        baySelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // ì—ëŸ¬ ì‹œ ë©”ì‹œì§€ í‘œì‹œ
                    baySelect.innerHTML = '<option value="">íƒ€ì„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
                });
        });
        
        // í˜„ì¬ ìƒí™© í™•ì¸ í•¨ìˆ˜
        function checkCurrentStatus() {
            const storeId = storeSelect.value;
            const bayId = baySelect.value;
            
            if (storeId && bayId) {
                fetch(`/api/active_user?store_id=${storeId}&bay_id=${bayId}`)
                    .then(response => {
                        if (!response.ok) {
                            // HTTP ì—ëŸ¬ ì‘ë‹µ ì²˜ë¦¬
                            if (response.status === 401) {
                                alert('âš ï¸ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                                window.location.href = '/login';
                                throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤');
                            }
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const currentStatusDiv = document.getElementById('currentStatus');
                        const currentStatusText = document.getElementById('currentStatusText');
                        const storeName = storeSelect.options[storeSelect.selectedIndex].text;
                        const bayName = baySelect.options[baySelect.selectedIndex].text;
                        
                        if (data.user_id) {
                            currentStatusText.innerHTML = `
                                <strong>${storeName} ${bayName}</strong><br>
                                í˜„ì¬ ì‚¬ìš©ì: ${data.user_id}<br>
                                ë¡œê·¸ì¸ ì‹œê°„: ${new Date(data.login_time).toLocaleString('ko-KR')}
                            `;
                        } else {
                            currentStatusText.innerHTML = `
                                <strong>${storeName} ${bayName}</strong><br>
                                í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥ (ì‚¬ìš©ì ì—†ìŒ)
                            `;
                        }
                        currentStatusDiv.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            } else {
                document.getElementById('currentStatus').style.display = 'none';
            }
        }
        
        // ë§¤ì¥/íƒ€ì„ ì„ íƒ ë³€ê²½ ì‹œ í˜„ì¬ ìƒí™© í™•ì¸
        storeSelect.addEventListener('change', function() {
            checkCurrentStatus();
        });
        
        baySelect.addEventListener('change', function() {
            checkCurrentStatus();
        });
        
        // í¼ ì œì¶œ ì‹œ AJAXë¡œ ì²˜ë¦¬ (ì˜¤ë¥˜ ì‹œ alert í‘œì‹œ)
        document.getElementById('selectForm').addEventListener('submit', function(e) {
            e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€
            
            const storeId = storeSelect.value;
            const bayId = baySelect.value;
            
            if (!storeId || !bayId) {
                alert('ë§¤ì¥ê³¼ íƒ€ì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // FormDataë¡œ í¼ ë°ì´í„° ìƒì„±
            const formData = new FormData();
            formData.append('store_id', storeId);
            formData.append('bay_id', bayId);
            
            // AJAX ìš”ì²­
            fetch('{{ url_for("select_store_bay") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.redirected) {
                    // ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ë©´ ì„±ê³µ (ìƒ· ìˆ˜ì§‘ í˜ì´ì§€ë¡œ ì´ë™)
                    window.location.href = response.url;
                } else {
                    // ì˜¤ë¥˜ ì‘ë‹µ (HTML ë°˜í™˜)
                    return response.text().then(html => {
                        // ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ë²•)
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const errorDiv = doc.querySelector('.user-login-error');
                        
                        if (errorDiv) {
                            const errorMessage = errorDiv.textContent.trim();
                            alert(errorMessage || 'íƒ€ì„ ì„ íƒ ì‹¤íŒ¨. ë‹¤ë¥¸ íƒ€ì„ì„ ì´ìš©í•˜ì„¸ìš”.');
                        } else {
                            alert('ì™„ë£Œëœ íƒ€ì„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ íƒ€ì„ì„ ì´ìš©í•˜ì„¸ìš”.');
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // HTTP ìƒíƒœ ì½”ë“œì— ë”°ë¥¸ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                let errorMessage = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                if (error.message) {
                    errorMessage = `âš ï¸ ${error.message}`;
                }
                alert(errorMessage);
            });
        });
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ alertë¡œ í‘œì‹œ
        {% if error %}
        window.addEventListener('DOMContentLoaded', function() {
            alert('{{ error }}');
        });
        {% endif %}
        
        // ì´ˆê¸° ì„ íƒê°’ì´ ìˆìœ¼ë©´ íƒ€ì„ ëª©ë¡ ë¡œë“œ
        {% if selected_store_id %}
        storeSelect.dispatchEvent(new Event('change'));
        {% endif %}
    </script>
</body>
</html>
