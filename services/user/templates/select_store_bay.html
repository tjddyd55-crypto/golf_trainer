<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¥/íƒ€ì„ ì„ íƒ - Golf Trainer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user.css') }}">
</head>
<body>
    <div class="user-login-container">
        <div class="user-login-card">
            <h2 class="user-login-title">ğŸŒï¸ ë§¤ì¥/íƒ€ì„ ì„ íƒ</h2>
            
            {% if error %}
            <div class="user-login-error">
                {{ error }}
            </div>
            {% endif %}
            
            <form method="POST" id="selectForm">
                <div class="user-login-form-group">
                    <label class="user-login-label">ë§¤ì¥ ì„ íƒ</label>
                    <select name="store_id" id="storeSelect" class="user-login-input" required>
                        <option value="">ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        {% for store in stores %}
                        <option value="{{ store.store_id }}" {% if selected_store_id == store.store_id %}selected{% endif %}>
                            {{ store.store_name or store.store_id }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="user-login-form-group">
                    <label class="user-login-label">íƒ€ì„ ì„ íƒ</label>
                    <select name="bay_id" id="baySelect" class="user-login-input" required>
                        <option value="">ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <button type="submit" class="user-login-button">í™•ì¸</button>
            </form>
            
            <div id="statusMessage" class="user-mt-3">
                <div class="alert alert-info" id="statusBox" style="display: none;">
                    <strong id="statusText"></strong>
                </div>
            </div>
            
            <!-- í˜„ì¬ ìƒí™© í‘œì‹œ ì˜ì—­ -->
            <div id="currentStatus" class="user-mt-3" style="display: none;">
                <div class="alert alert-success">
                    <strong>ğŸ“ í˜„ì¬ ìƒí™©:</strong>
                    <div id="currentStatusText"></div>
                </div>
            </div>
            
            <div class="user-text-center user-mt-3">
                <a href="{{ url_for('logout') }}" class="user-btn user-btn-secondary">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </div>
    
    <script>
        const storeSelect = document.getElementById('storeSelect');
        const baySelect = document.getElementById('baySelect');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        
        // ë§¤ì¥ ì„ íƒ ì‹œ íƒ€ì„ ëª©ë¡ ë¡œë“œ
        storeSelect.addEventListener('change', function() {
            const storeId = this.value;
            baySelect.innerHTML = '<option value="">ë¡œë”© ì¤‘...</option>';
            
            if (!storeId) {
                baySelect.innerHTML = '<option value="">ë¨¼ì € ë§¤ì¥ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }
            
            // íƒ€ì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ê°„ë‹¨í•˜ê²Œ 1~5ë²ˆ íƒ€ì„)
            fetch(`/api/get_bays?store_id=${storeId}`)
                .then(response => response.json())
                .then(data => {
                    baySelect.innerHTML = '<option value="">íƒ€ì„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    if (data.bays && data.bays.length > 0) {
                        data.bays.forEach(bay => {
                            const option = document.createElement('option');
                            option.value = bay.bay_id;
                            option.textContent = `${bay.bay_id}ë²ˆ íƒ€ì„`;
                            baySelect.appendChild(option);
                        });
                    } else {
                        // ê¸°ë³¸ íƒ€ì„ ìƒì„± (1~5ë²ˆ)
                        for (let i = 1; i <= 5; i++) {
                            const option = document.createElement('option');
                            option.value = String(i).padStart(2, '0');
                            option.textContent = `${i}ë²ˆ íƒ€ì„`;
                            baySelect.appendChild(option);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // ê¸°ë³¸ íƒ€ì„ ìƒì„±
                    baySelect.innerHTML = '<option value="">íƒ€ì„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                    for (let i = 1; i <= 5; i++) {
                        const option = document.createElement('option');
                        option.value = String(i).padStart(2, '0');
                        option.textContent = `${i}ë²ˆ íƒ€ì„`;
                        baySelect.appendChild(option);
                    }
                });
        });
        
        // í˜„ì¬ ìƒí™© í™•ì¸ í•¨ìˆ˜
        function checkCurrentStatus() {
            const storeId = storeSelect.value;
            const bayId = baySelect.value;
            
            if (storeId && bayId) {
                fetch(`/api/active_user?store_id=${storeId}&bay_id=${bayId}`)
                    .then(response => response.json())
                    .then(data => {
                        const currentStatusDiv = document.getElementById('currentStatus');
                        const currentStatusText = document.getElementById('currentStatusText');
                        const storeName = storeSelect.options[storeSelect.selectedIndex].text;
                        const bayName = baySelect.options[baySelect.selectedIndex].text;
                        
                        if (data.user_id) {
                            currentStatusText.innerHTML = `
                                <strong>${storeName} ${bayName}</strong><br>
                                í˜„ì¬ ì‚¬ìš©ì: ${data.user_id}<br>
                                ë¡œê·¸ì¸ ì‹œê°„: ${new Date(data.login_time).toLocaleString('ko-KR')}
                            `;
                        } else {
                            currentStatusText.innerHTML = `
                                <strong>${storeName} ${bayName}</strong><br>
                                í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥ (ì‚¬ìš©ì ì—†ìŒ)
                            `;
                        }
                        currentStatusDiv.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            } else {
                document.getElementById('currentStatus').style.display = 'none';
            }
        }
        
        // ë§¤ì¥/íƒ€ì„ ì„ íƒ ë³€ê²½ ì‹œ í˜„ì¬ ìƒí™© í™•ì¸
        storeSelect.addEventListener('change', function() {
            checkCurrentStatus();
        });
        
        baySelect.addEventListener('change', function() {
            checkCurrentStatus();
        });
        
        // í¼ ì œì¶œ ì‹œ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ ë° ì˜¤ë¥˜ ì²˜ë¦¬
        document.getElementById('selectForm').addEventListener('submit', function(e) {
            const storeId = storeSelect.value;
            const bayId = baySelect.value;
            const storeName = storeSelect.options[storeSelect.selectedIndex].text;
            const bayName = baySelect.options[baySelect.selectedIndex].text;
            
            if (!storeId || !bayId) {
                return; // í¼ ê²€ì¦ì€ ê¸°ë³¸ HTML5 ê²€ì¦ ì‚¬ìš©
            }
            
            // ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ alertë¡œ í‘œì‹œ
            {% if error %}
            alert('{{ error }}');
            {% endif %}
            
            if (storeId && bayId) {
                statusText.textContent = `${storeName} ${bayName} ì´ìš©ì¤‘`;
                document.getElementById('statusBox').style.display = 'block';
            }
        });
        
        // ì´ˆê¸° ì„ íƒê°’ì´ ìˆìœ¼ë©´ íƒ€ì„ ëª©ë¡ ë¡œë“œ
        {% if selected_store_id %}
        storeSelect.dispatchEvent(new Event('change'));
        {% endif %}
    </script>
</body>
</html>
