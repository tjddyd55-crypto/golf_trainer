# 데이터베이스 마이그레이션 실행 가이드

## ✅ 방법 1: Railway 대시보드에서 직접 실행 (가장 간단)

### 단계별 안내

1. **Railway 대시보드 접속**
   - https://railway.app 접속
   - 프로젝트 선택

2. **PostgreSQL 서비스 선택**
   - 왼쪽 사이드바에서 PostgreSQL 서비스 클릭

3. **Query 탭 열기**
   - 상단 탭에서 **Query** 클릭

4. **SQL 실행**
   - 아래 SQL을 복사하여 Query 창에 붙여넣기
   - **Run Query** 버튼 클릭

```sql
-- ============================================
-- 데이터베이스 마이그레이션 스크립트 (최종)
-- ============================================

-- store_pcs: usage_end_date / usage_start_date TEXT -> DATE
DO $$
BEGIN
  IF EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public' AND table_name='store_pcs'
      AND column_name='usage_end_date' AND data_type='text'
  ) THEN
    ALTER TABLE store_pcs
      ALTER COLUMN usage_end_date TYPE DATE
      USING CASE
        WHEN usage_end_date IS NULL OR usage_end_date = '' THEN NULL
        WHEN usage_end_date ~ '^\d{4}-\d{2}-\d{2}$' THEN usage_end_date::DATE
        ELSE NULL
      END;
  END IF;

  IF EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public' AND table_name='store_pcs'
      AND column_name='usage_start_date' AND data_type='text'
  ) THEN
    ALTER TABLE store_pcs
      ALTER COLUMN usage_start_date TYPE DATE
      USING CASE
        WHEN usage_start_date IS NULL OR usage_start_date = '' THEN NULL
        WHEN usage_start_date ~ '^\d{4}-\d{2}-\d{2}$' THEN usage_start_date::DATE
        ELSE NULL
      END;
  END IF;
END $$;

-- users: birth_date TEXT -> DATE
DO $$
BEGIN
  IF EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public' AND table_name='users'
      AND column_name='birth_date' AND data_type='text'
  ) THEN
    ALTER TABLE users
      ALTER COLUMN birth_date TYPE DATE
      USING CASE
        WHEN birth_date IS NULL OR birth_date = '' THEN NULL
        WHEN birth_date ~ '^\d{4}-\d{2}-\d{2}$' THEN birth_date::DATE
        ELSE NULL
      END;
  END IF;
END $$;

-- stores: subscription_start_date / subscription_end_date TEXT -> DATE
DO $$
BEGIN
  IF EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores'
      AND column_name='subscription_end_date' AND data_type='text'
  ) THEN
    ALTER TABLE stores
      ALTER COLUMN subscription_end_date TYPE DATE
      USING CASE
        WHEN subscription_end_date IS NULL OR subscription_end_date = '' THEN NULL
        WHEN subscription_end_date ~ '^\d{4}-\d{2}-\d{2}$' THEN subscription_end_date::DATE
        ELSE NULL
      END;
  END IF;

  IF EXISTS (
    SELECT 1
    FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores'
      AND column_name='subscription_start_date' AND data_type='text'
  ) THEN
    ALTER TABLE stores
      ALTER COLUMN subscription_start_date TYPE DATE
      USING CASE
        WHEN subscription_start_date IS NULL OR subscription_start_date = '' THEN NULL
        WHEN subscription_start_date ~ '^\d{4}-\d{2}-\d{2}$' THEN subscription_start_date::DATE
        ELSE NULL
      END;
  END IF;
END $$;

-- stores 테이블 컬럼 추가
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores' AND column_name='contact'
  ) THEN
    ALTER TABLE stores ADD COLUMN contact TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores' AND column_name='business_number'
  ) THEN
    ALTER TABLE stores ADD COLUMN business_number TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores' AND column_name='owner_name'
  ) THEN
    ALTER TABLE stores ADD COLUMN owner_name TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores' AND column_name='email'
  ) THEN
    ALTER TABLE stores ADD COLUMN email TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='stores' AND column_name='address'
  ) THEN
    ALTER TABLE stores ADD COLUMN address TEXT;
  END IF;
END $$;

-- store_pcs 테이블 컬럼 추가
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='store_pcs' AND column_name='store_id'
  ) THEN
    ALTER TABLE store_pcs ADD COLUMN store_id TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='store_pcs' AND column_name='bay_id'
  ) THEN
    ALTER TABLE store_pcs ADD COLUMN bay_id TEXT;
  END IF;

  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='store_pcs' AND column_name='blocked_reason'
  ) THEN
    ALTER TABLE store_pcs ADD COLUMN blocked_reason TEXT;
  END IF;
END $$;

-- shots 테이블 컬럼 추가
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_schema='public' AND table_name='shots' AND column_name='pc_unique_id'
  ) THEN
    ALTER TABLE shots ADD COLUMN pc_unique_id TEXT;
  END IF;
END $$;

-- 인덱스 추가
CREATE INDEX IF NOT EXISTS idx_store_pcs_store_status_end
ON store_pcs (store_id, status, usage_end_date);

CREATE UNIQUE INDEX IF NOT EXISTS ux_stores_store_id
ON stores (store_id);

CREATE INDEX IF NOT EXISTS idx_shots_pc_unique_id
ON shots (pc_unique_id);

CREATE INDEX IF NOT EXISTS idx_shots_store_bay
ON shots (store_id, bay_id);
```

## 방법 2: Python 스크립트로 실행

### Railway PostgreSQL Public Network URL 확인
1. Railway 대시보드 > PostgreSQL 서비스
2. **Connect** 탭 클릭
3. **Public Network** 섹션의 URL 복사

### 실행
```powershell
# PowerShell에서
$env:DATABASE_URL="여기에_복사한_URL_붙여넣기"
python run_migration_simple.py
```

또는 `database_migration_final.sql` 파일 전체 내용을 Railway Query 탭에 붙여넣어 실행하세요.
