<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë“œë¼ì´ë²„ìƒ· í™”ë©´ ìº¡ì²˜ í…ŒìŠ¤íŠ¸</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #121212; color: white; padding: 20px; }
        .test-card { background-color: #1f1f1f; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
        .result-box { background-color: #0d1117; padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; }
        .btn-test { margin: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="mb-4">ğŸ¯ ë“œë¼ì´ë²„ìƒ· í™”ë©´ ìº¡ì²˜ í…ŒìŠ¤íŠ¸</h2>
        
        <div class="test-card">
            <h4>1. í˜„ì¬ í™œì„± ì‚¬ìš©ì í™•ì¸</h4>
            <button class="btn btn-primary btn-test" onclick="checkActiveUser()">í™œì„± ì‚¬ìš©ì ì¡°íšŒ</button>
            <div id="activeUserResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-card">
            <h4>2. í™”ë©´ ìº¡ì²˜ ì˜ì—­ í™•ì¸</h4>
            <p class="text-secondary">í˜„ì¬ ì„¤ì •ëœ ìº¡ì²˜ ì˜ì—­ ì •ë³´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
            <button class="btn btn-success btn-test" onclick="checkRegions()">ì˜ì—­ ì •ë³´ í™•ì¸</button>
            <div id="regionsResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-card">
            <h4>3. ğŸ“¸ ìº¡ì²˜ ì´ë¯¸ì§€ íŒŒì¼ë¡œ OCR í…ŒìŠ¤íŠ¸</h4>
            <p class="text-secondary">ê³¨í”„ ì‹œë®¬ë ˆì´í„° í™”ë©´ ìº¡ì²˜ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ë©´ OCRë¡œ ìƒ· ë°ì´í„°ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤.</p>
            
            <div class="mb-3">
                <label class="form-label text-secondary small">ë‹¨ì¼ ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸</label>
                <input type="file" id="captureFile" accept="image/*" class="form-control bg-dark text-white mb-2">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="debugMode">
                    <label class="form-check-label text-secondary small" for="debugMode">
                        ë””ë²„ê·¸ ëª¨ë“œ (ê° ì˜ì—­ ì´ë¯¸ì§€ í™•ì¸)
                    </label>
                </div>
                <button class="btn btn-warning btn-test" onclick="testUploadImage()">ì´ë¯¸ì§€ì—ì„œ ìƒ· ë°ì´í„° ì½ê¸°</button>
            </div>
            
            <div class="mb-3">
                <label class="form-label text-secondary small">ì—¬ëŸ¬ ì´ë¯¸ì§€ ì¼ê´„ í…ŒìŠ¤íŠ¸ (1.png ~ 5.png)</label>
                <input type="file" id="batchFiles" accept="image/*" multiple class="form-control bg-dark text-white mb-2">
                <button class="btn btn-success btn-test" onclick="testBatchImages()">ì¼ê´„ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
                <div id="batchProgress" class="mt-2" style="display:none;">
                    <div class="progress mb-2">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                    </div>
                    <div id="batchStatus" class="text-secondary small"></div>
                </div>
            </div>
            
            <div id="uploadResult" class="result-box" style="display:none;"></div>
            <div id="batchResult" class="result-box" style="display:none;"></div>
            <div id="imagePreview" style="margin-top: 10px; display:none;">
                <img id="previewImg" style="max-width: 100%; border: 1px solid #444; border-radius: 5px;">
            </div>
        </div>

        <div class="test-card">
            <h4>4. ìˆ˜ë™ ìƒ· ë°ì´í„° ì½ê¸° í…ŒìŠ¤íŠ¸ (ì‹¤ì‹œê°„ í™”ë©´)</h4>
            <p class="text-secondary">í˜„ì¬ í™”ë©´ì—ì„œ ìƒ· ë°ì´í„°ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤. (main.pyê°€ ì‹¤í–‰ ì¤‘ì´ì–´ì•¼ í•¨)</p>
            <button class="btn btn-warning btn-test" onclick="testReadShot()">ìƒ· ë°ì´í„° ì½ê¸°</button>
            <div id="shotResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="test-card">
            <h4>5. ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œê·¸ë¨ ìƒíƒœ</h4>
            <p class="text-secondary">main.pyê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
            <button class="btn btn-info btn-test" onclick="checkMainStatus()">ìƒíƒœ í™•ì¸</button>
            <div id="statusResult" class="result-box" style="display:none;"></div>
        </div>

        <div class="mt-4">
            <a href="/" class="btn btn-secondary">í™ˆìœ¼ë¡œ</a>
            <a href="/user/main" class="btn btn-secondary">ìœ ì € ë©”ì¸</a>
        </div>
    </div>

    <script>
        async function checkActiveUser() {
            const resultDiv = document.getElementById('activeUserResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ì¡°íšŒ ì¤‘...';
            
            try {
                const response = await fetch('/api/active_user?store_id=gaja&bay_id=01');
                const data = await response.json();
                resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }

        async function checkRegions() {
            const resultDiv = document.getElementById('regionsResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ì¡°íšŒ ì¤‘...';
            
            try {
                const response = await fetch('/api/regions');
                const data = await response.json();
                resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }

        async function testReadShot() {
            const resultDiv = document.getElementById('shotResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ìƒ· ë°ì´í„° ì½ëŠ” ì¤‘... (í™”ë©´ì´ ê³¨í”„ ì‹œë®¬ë ˆì´í„° í™”ë©´ì¸ì§€ í™•ì¸í•˜ì„¸ìš”)';
            
            try {
                const response = await fetch('/api/test_read_shot', { method: 'POST' });
                const data = await response.json();
                if (data.error) {
                    resultDiv.innerHTML = `<span style="color: orange;">âš ï¸ ${data.error}</span>`;
                } else {
                    resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }

        async function testUploadImage() {
            const fileInput = document.getElementById('captureFile');
            const resultDiv = document.getElementById('uploadResult');
            const previewDiv = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘...';
            
            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // FormDataë¡œ íŒŒì¼ ì—…ë¡œë“œ
            const formData = new FormData();
            formData.append('image', file);
            
            // ë””ë²„ê·¸ ëª¨ë“œ í™•ì¸
            const debugMode = document.getElementById('debugMode')?.checked || false;
            const url = debugMode ? '/api/test_upload_image?debug=true' : '/api/test_upload_image';
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<span style="color: red;">âŒ ì˜¤ë¥˜: ${data.error}</span>`;
                } else {
                    let html = '<h5 style="color: #28a745;">âœ… OCR ê²°ê³¼:</h5>';
                    html += '<pre style="background: #0d1117; padding: 10px; border-radius: 5px;">';
                    html += JSON.stringify(data, null, 2);
                    html += '</pre>';
                    
                    // ì½ì€ ê°’ë“¤ì„ í‘œ í˜•ì‹ìœ¼ë¡œë„ í‘œì‹œ
                    if (data.metrics) {
                        html += '<h5 style="margin-top: 15px; color: #0dcaf0;">ğŸ“Š ì½ì€ ë°ì´í„°:</h5>';
                        html += '<table class="table table-dark" style="margin-top: 10px;">';
                        html += '<thead><tr><th>í•­ëª©</th><th>ê°’</th><th>OCR í…ìŠ¤íŠ¸</th></tr></thead><tbody>';
                        for (const [key, value] of Object.entries(data.metrics)) {
                            const ocrText = data.ocr_texts[key] || '-';
                            html += `<tr>
                                <td><strong>${key}</strong></td>
                                <td>${value !== null ? value : '<span style="color: #888;">-</span>'}</td>
                                <td><code style="color: #ffc107;">${ocrText}</code></td>
                            </tr>`;
                        }
                        html += '</tbody></table>';
                    }
                    
                    // ë””ë²„ê·¸ ëª¨ë“œ: ê° ì˜ì—­ ì´ë¯¸ì§€ í‘œì‹œ (regions.json ìˆœì„œëŒ€ë¡œ)
                    if (data.debug_regions) {
                        html += '<h5 style="margin-top: 15px; color: #ff6b6b;">ğŸ” ë””ë²„ê·¸: ê° ì˜ì—­ ì´ë¯¸ì§€</h5>';
                        html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">';
                        
                        // regions.jsonì˜ ìˆœì„œëŒ€ë¡œ í‘œì‹œ (ball_speed, club_speed, launch_angle, back_spin, club_path, lateral_offset, direction_angle, side_spin, face_angle)
                        const regionOrder = ['ball_speed', 'club_speed', 'launch_angle', 'back_spin', 'club_path', 'lateral_offset', 'direction_angle', 'side_spin', 'face_angle'];
                        
                        for (const key of regionOrder) {
                            if (data.debug_regions[key]) {
                                const info = data.debug_regions[key];
                                html += `<div style="border: 1px solid #444; padding: 5px; border-radius: 5px;">`;
                                html += `<div class="text-secondary small"><strong>${key}</strong></div>`;
                                if (info.error) {
                                    html += `<div style="color: red; padding: 10px;">ì˜¤ë¥˜: ${info.error}</div>`;
                                } else if (info.image) {
                                    html += `<img src="${info.image}" style="max-width: 100%; border: 1px solid #666; background: #000;">`;
                                }
                                html += `<div class="text-secondary small">${info.region.w}x${info.region.h}</div>`;
                                html += `</div>`;
                            }
                        }
                        html += '</div>';
                    }
                    
                    resultDiv.innerHTML = html;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">âŒ ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }

        async function testBatchImages() {
            const fileInput = document.getElementById('batchFiles');
            const batchResult = document.getElementById('batchResult');
            const batchProgress = document.getElementById('batchProgress');
            const progressBar = document.getElementById('progressBar');
            const batchStatus = document.getElementById('batchStatus');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const files = Array.from(fileInput.files);
            batchResult.style.display = 'block';
            batchProgress.style.display = 'block';
            batchResult.innerHTML = '<h5>ì¼ê´„ í…ŒìŠ¤íŠ¸ ì‹œì‘...</h5>';
            
            const results = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = ((i + 1) / files.length) * 100;
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
                batchStatus.textContent = `ì²˜ë¦¬ ì¤‘: ${file.name} (${i + 1}/${files.length})`;
                
                const formData = new FormData();
                formData.append('image', file);
                
                try {
                    const response = await fetch('/api/test_upload_image', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    results.push({
                        filename: file.name,
                        success: !data.error,
                        data: data
                    });
                } catch (error) {
                    results.push({
                        filename: file.name,
                        success: false,
                        error: error.message
                    });
                }
            }
            
            // ê²°ê³¼ í‘œì‹œ
            let html = '<h5 style="color: #28a745;">âœ… ì¼ê´„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ</h5>';
            html += '<table class="table table-dark table-sm" style="margin-top: 10px;">';
            html += '<thead><tr><th>íŒŒì¼ëª…</th><th>ìƒíƒœ</th><th>ë³¼ìŠ¤í”¼ë“œ</th><th>í´ëŸ½ìŠ¤í”¼ë“œ</th><th>ìŠ¤ë§¤ì‹œ</th><th>ë°œì‚¬ê°</th><th>í˜ì´ìŠ¤ê°</th></tr></thead>';
            html += '<tbody>';
            
            results.forEach(result => {
                const metrics = result.data?.metrics || {};
                const status = result.success ? '<span style="color: #28a745;">âœ… ì„±ê³µ</span>' : '<span style="color: #dc3545;">âŒ ì‹¤íŒ¨</span>';
                html += `<tr>
                    <td><strong>${result.filename}</strong></td>
                    <td>${status}</td>
                    <td>${metrics.ball_speed !== null && metrics.ball_speed !== undefined ? metrics.ball_speed : '-'}</td>
                    <td>${metrics.club_speed !== null && metrics.club_speed !== undefined ? metrics.club_speed : '-'}</td>
                    <td>${metrics.smash_factor !== null && metrics.smash_factor !== undefined ? metrics.smash_factor : '-'}</td>
                    <td>${metrics.launch_angle !== null && metrics.launch_angle !== undefined ? metrics.launch_angle : '-'}</td>
                    <td>${metrics.face_angle !== null && metrics.face_angle !== undefined ? metrics.face_angle : '-'}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            // ìƒì„¸ ê²°ê³¼ ì ‘ê¸°/í¼ì¹˜ê¸°
            html += '<details style="margin-top: 15px;"><summary style="cursor: pointer; color: #0dcaf0;">ğŸ“‹ ìƒì„¸ ê²°ê³¼ ë³´ê¸°</summary>';
            html += '<pre style="background: #0d1117; padding: 10px; border-radius: 5px; margin-top: 10px; max-height: 400px; overflow-y: auto;">';
            html += JSON.stringify(results, null, 2);
            html += '</pre></details>';
            
            batchResult.innerHTML = html;
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            batchStatus.textContent = `ì™„ë£Œ: ${files.length}ê°œ íŒŒì¼ ì²˜ë¦¬ë¨`;
        }

        async function checkMainStatus() {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'í™•ì¸ ì¤‘...';
            
            try {
                const response = await fetch('/api/main_status');
                const data = await response.json();
                resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: red;">ì˜¤ë¥˜: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
